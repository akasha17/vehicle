{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="{% static 'css/adminstyle.css' %}" rel="stylesheet">
  <title>Admin Dashboard - Vehicle Fleet</title>

  <!-- Leaflet (no API key needed) -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
  <style>
    /* Small helpers for the map card to match your theme */
    .map-card { margin-top:18px; }
    #map { height: 420px; width: 100%; border-radius: 8px; overflow: hidden; }
    .muted { color:#64748b; font-size:12px; }
    .btn.small { padding:6px 10px; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">ADMINISTRATION</div>
      <div class="welcome">
        <div style="font-size:16px">Welcome, <strong>{{ request.user.username|default:"Admin" }}</strong></div>
      </div>

      <nav class="nav" aria-label="main navigation">
        <a href="{% url 'profile' %}" class="">
          <span class="icon">üë§</span><span>Profile</span>
        </a>
        <a href="{% url 'admin_dashboard' %}" class="active">
          <span class="icon">üìä</span><span>Dashboard</span>
        </a>
        <a href="{% url 'vehicle_list' %}">
          <span class="icon">üöó</span><span>Vehicles</span>
        </a>
        <a href="{% url 'register_staff' %}">
          <span class="icon">üë•</span><span>Add Staff</span>
        </a>
        <a href="{% url 'add_driver' %}">
          <span class="icon">üë•</span><span>Add driver</span>
        </a>
        <a href="{% url 'maintenance_list' %}">
          <span class="icon">üõ†Ô∏è</span><span>Maintenance</span>
        </a>
        <a href="{% url 'fuel_logs' %}">
          <span class="icon">‚õΩ</span><span>Fuel Logs</span>
        </a>
        <a href="{% url 'logout' %}">
          <span class="icon">üîì</span><span>Logout</span>
        </a>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="topbar">Vehicle Fleet Management - Admin</header>

      <section class="content">
        <div class="page-title">VIEW VEHICLES & DASHBOARD</div>

        <div class="card" style="margin-bottom:18px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="section-title">Fleet Overview</div>
            <div>
              <a href="{% url 'add_vehicle' %}" class="btn">+ Add Vehicle</a>
            </div>
          </div>

          <div style="display:flex;gap:14px;margin-bottom:14px;flex-wrap:wrap">
            <div style="flex:0 0 180px;background:linear-gradient(180deg, rgba(7,197,127,0.08), rgba(7,197,127,0.02));padding:12px;border-radius:8px">
              <div class="small-muted">Total Vehicles</div>
              <div style="font-size:20px;font-weight:700">{{ chart_data.total_vehicles }}</div>
            </div>

            <div style="flex:0 0 180px;background:#fff;padding:12px;border-radius:8px;border:1px solid #f0f0f0">
              <div class="small-muted">Assigned</div>
              <div style="font-size:20px;font-weight:700">{{ chart_data.assigned }}</div>
            </div>

            <div style="flex:0 0 180px;background:#fff;padding:12px;border-radius:8px;border:1px solid #f0f0f0">
              <div class="small-muted">Not Assigned</div>
              <div style="font-size:20px;font-weight:700">{{ chart_data.not_assigned }}</div>
            </div>

            <div style="flex:0 0 180px;background:#fff;padding:12px;border-radius:8px;border:1px solid #f0f0f0">
              <div class="small-muted">Under Maintenance</div>
              <div style="font-size:20px;font-weight:700">{{ chart_data.under_maintenance }}</div>
            </div>
          </div>

          <!-- vehicles table -->
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Reg. No</th>
                  <th>Make</th>
                  <th>Model</th>
                  <th>Year</th>
                  <th>Driver</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for v in vehicles %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ v.registration_no }}</td>
                  <td>{{ v.make|default:"‚Äî" }}</td>
                  <td>{{ v.model|default:"‚Äî" }}</td>
                  <td>{{ v.year|default:"‚Äî" }}</td>
                  <td>{% if v.current_driver %}{{ v.current_driver.username }}{% else %}<span class="small-muted">Not assigned</span>{% endif %}</td>
                  <td>{{ v.get_status_display }}</td>
                  <td>
                    <a href="{% url 'assign_vehicle' v.pk %}" class="btn outline">Assign</a>
                    <a href="{% url 'update_vehicle_location' v.pk %}" class="btn outline small" style="margin-left:6px">Update Location</a>
                    <a href="{% url 'delete_vehicle' v.pk %}" onclick="return confirm('Delete vehicle?')" class="btn outline" style="margin-left:6px">Delete</a>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="8" class="small-muted">No vehicles yet.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- ===== Vehicle Tracking (Map) ===== -->
        <div class="card map-card">
          <div class="section-title" style="margin-bottom:10px">Vehicle Tracking</div>
          <div id="map"></div>
          <div class="muted" style="margin-top:8px">
            Auto-refreshes every 10 seconds. Click a marker to view vehicle & quick actions.
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 360px;gap:18px;align-items:start">

          <!-- left: recent maintenance -->
          <div class="card">
            <div class="section-title">Recent Maintenance</div>
            <table>
              <thead><tr><th>Vehicle</th><th>Date</th><th>Next Due</th><th>Added by</th></tr></thead>
              <tbody>
                {% for m in maintenance_logs|slice:":6" %}
                <tr>
                  <td>{{ m.vehicle.registration_no }}</td>
                  <td>{{ m.date }}</td>
                  <td>{% if m.next_due %}{{ m.next_due }}{% else %}‚Äî{% endif %}</td>
                  <td>{% if m.created_by %}{{ m.created_by.username }}{% else %}‚Äî{% endif %}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="small-muted">No maintenance logs.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- right: quick actions / staff list -->
          <aside class="card right-col">
            <div class="section-title">Quick Actions</div>
            <div style="display:flex;flex-direction:column;gap:10px">
              <a href="{% url 'register_staff' %}" class="btn">Create Staff / Driver</a>
              <a href="{% url 'add_vehicle' %}" class="btn outline">Add Vehicle</a>
              <a href="{% url 'vehicle_list' %}" class="btn outline">View All Vehicles</a>
            </div>

            <div style="margin-top:16px">
              <div class="section-title" style="margin-top:14px">Staff</div>
              <ul style="list-style:none;padding:0;margin:0">
                {% for p in profiles|slice:":6" %}
                  <li style="padding:8px 0;border-bottom:1px dashed #eee">
                    <strong>{{ p.user.username }}</strong><div class="small-muted">Role: {{ p.role }}</div>
                  </li>
                {% empty %}
                  <li class="small-muted">No users</li>
                {% endfor %}
              </ul>
            </div>
          </aside>
        </div>

      </section>
    </main>
  </div>

  <!-- Map script -->
  <script>
    (function(){
      var map = L.map('map').setView([20.5937, 78.9629], 5); // India as default view
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      var markers = {}; // id -> marker

      function upsertMarker(v) {
        var id = String(v.id);
        var html = `
          <div>
            <b>${v.reg}</b><br/>
            ${v.make || ''} ${v.model || ''}<br/>
            Status: <b>${v.status}</b><br/>
            Driver: ${v.driver || '-'}<br/>
            Updated: ${v.updated ? new Date(v.updated).toLocaleString() : '-'}<br/>
            <div style="margin-top:6px;">
              <a class="btn small" href="/admin/vehicles/${v.id}/update-location/">Update location</a>
              <a class="btn small" href="/admin/vehicles/${v.id}/assign/" style="margin-left:6px;">Assign</a>
            </div>
          </div>
        `;
        if (markers[id]) {
          markers[id].setLatLng([v.lat, v.lng]).bindPopup(html);
        } else {
          markers[id] = L.marker([v.lat, v.lng]).addTo(map).bindPopup(html);
        }
      }

      function refresh() {
        fetch("{% url 'vehicle_track_data' %}", {cache: "no-store"})
          .then(r => r.json())
          .then(data => {
            var seen = {};
            (data.vehicles || []).forEach(v => {
              upsertMarker(v);
              seen[v.id] = true;
            });
            // remove markers that disappeared from feed
            Object.keys(markers).forEach(id => {
              if (!seen[id]) {
                map.removeLayer(markers[id]);
                delete markers[id];
              }
            });
          })
          .catch(console.error);
      }

      refresh();                 // initial load
      setInterval(refresh, 10000); // every 10s
    })();
  </script>
</body>
</html>
